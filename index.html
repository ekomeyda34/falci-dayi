<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Falcı Dayı</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        /* Önceki CSS kodunuz aynen kalacak */
        :root {
            --primary-color: #673ab7;
            --primary-light: #9a67ea;
            --primary-dark: #320b86;
            --text-color: #333;
            --light-gray: #f5f5f5;
            --medium-gray: #e0e0e0;
            --white: #ffffff;
            --border-radius: 8px;
            --default-padding: 16px;
            --default-spacing: 20px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Roboto', sans-serif;
            color: var(--text-color);
            background-color: var(--light-gray);
            line-height: 1.6;
        }

        .app-container {
            max-width: 800px;
            margin: 0 auto;
            padding: var(--default-padding);
        }

        .app-header {
            background-color: var(--primary-color);
            color: var(--white);
            padding: var(--default-padding);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .app-title {
            font-size: 1.5rem;
            font-weight: 500;
        }

        .icon-button {
            background: none;
            border: none;
            color: var(--white);
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: background-color 0.3s;
        }

        .icon-button:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .section-title {
            font-size: 1.125rem;
            font-weight: 700;
            margin-bottom: var(--default-spacing);
            text-align: center;
        }

        .image-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: var(--default-spacing);
        }

        .image-container {
            position: relative;
            aspect-ratio: 1/1;
            border-radius: var(--border-radius);
            overflow: hidden;
            background-color: var(--medium-gray);
        }

        .image-preview {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .add-image {
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            background-color: var(--medium-gray);
        }

        .add-image i {
            font-size: 40px;
            color: #757575;
        }

        .remove-button {
            position: absolute;
            top: 0;
            right: 0;
            background-color: rgba(0, 0, 0, 0.5);
            color: var(--white);
            border: none;
            width: 32px;
            height: 32px;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 0 0 0 var(--border-radius);
            cursor: pointer;
        }

        .analyze-button {
            background-color: var(--primary-color);
            color: var(--white);
            border: none;
            padding: var(--default-padding);
            border-radius: var(--border-radius);
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            width: 100%;
            margin-bottom: var(--default-spacing);
            transition: background-color 0.3s;
        }

        .analyze-button:hover {
            background-color: var(--primary-dark);
        }

        .analyze-button:disabled {
            background-color: var(--medium-gray);
            cursor: not-allowed;
        }

        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 3px solid var(--white);
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .results-title {
            font-size: 1.125rem;
            font-weight: 700;
            margin-bottom: calc(var(--default-spacing) / 2);
        }

        .analysis-container {
            background-color: var(--white);
            border-radius: var(--border-radius);
            padding: 12px;
            margin-bottom: calc(var(--default-spacing) / 2);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .analysis-title {
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 8px;
        }

        .analysis-text {
            font-size: 0.875rem;
            white-space: pre-line;
        }

        .hidden {
            display: none;
        }

        #file-input {
            display: none;
        }

        .error-message {
            color: #d32f2f;
            background-color: #ffebee;
            padding: 12px;
            border-radius: var(--border-radius);
            margin-bottom: var(--default-spacing);
        }

        .api-key-container {
            margin-bottom: var(--default-spacing);
        }

        .api-key-input {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--medium-gray);
            border-radius: var(--border-radius);
            font-family: 'Roboto', sans-serif;
        }
    </style>
</head>
<body>
    <header class="app-header">
        <h1 class="app-title">Falcı Dayı</h1>
        <button id="reset-button" class="icon-button hidden">
            <i class="material-icons">refresh</i>
        </button>
    </header>

    <main class="app-container">
        <h2 class="section-title">Falınız için 3 adet görsel yükleyin</h2>
        
        <div class="api-key-container">
            <input type="password" id="api-key-input" class="api-key-input" placeholder="OpenAI API anahtarınızı girin">
        </div>
        
        <input type="file" id="file-input" accept="image/*" multiple>
        <div class="image-grid" id="image-grid">
            <div class="image-container add-image" id="add-image">
                <i class="material-icons">add_a_photo</i>
            </div>
        </div>

        <button id="analyze-button" class="analyze-button" disabled>
            <span id="button-text">Dayıya Sor</span>
            <div id="spinner" class="spinner hidden"></div>
        </button>

        <div id="error-container" class="hidden"></div>

        <div id="results-container" class="hidden">
            <h3 class="results-title">Dayı Diyor'ki:</h3>
            <div id="analysis-results"></div>
        </div>
    </main>

    <script>
        // DOM elements
        const imageGrid = document.getElementById('image-grid');
        const addImageBtn = document.getElementById('add-image');
        const fileInput = document.getElementById('file-input');
        const analyzeButton = document.getElementById('analyze-button');
        const buttonText = document.getElementById('button-text');
        const spinner = document.getElementById('spinner');
        const resultsContainer = document.getElementById('results-container');
        const analysisResults = document.getElementById('analysis-results');
        const resetButton = document.getElementById('reset-button');
        const errorContainer = document.getElementById('error-container');
        const apiKeyInput = document.getElementById('api-key-input');
        
        // State
        const images = [];
        const imageFiles = [];
        let isAnalyzing = false;

        // Event listeners
        addImageBtn.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', handleFileUpload);
        analyzeButton.addEventListener('click', analyzeImages);
        resetButton.addEventListener('click', resetAll);

        // Handle file upload
        function handleFileUpload(e) {
            const files = Array.from(e.target.files);
            if (files.length === 0) return;
            
            // Reset if we're starting over
            if (images.length + files.length > 3) {
                images.length = 0;
                imageFiles.length = 0;
            }
            
            let loadedCount = 0;
            
            files.slice(0, 3 - images.length).forEach(file => {
                // Check if image is too large (>4MB)
                if (file.size > 4 * 1024 * 1024) {
                    showError(`"${file.name}" dosyası çok büyük (maksimum 4MB)`);
                    return;
                }
                
                const reader = new FileReader();
                
                reader.onload = function(event) {
                    images.push(event.target.result);
                    imageFiles.push(file);
                    loadedCount++;
                    
                    if (loadedCount === Math.min(files.length, 3 - images.length)) {
                        renderImages();
                        fileInput.value = '';
                        
                        if (images.length > 0) {
                            analyzeButton.disabled = false;
                            resetButton.classList.remove('hidden');
                        }
                    }
                };
                
                reader.onerror = function() {
                    showError(`"${file.name}" yüklenirken hata oluştu`);
                    loadedCount++;
                };
                
                reader.readAsDataURL(file);
            });
        }

        function removeImage(index) {
            images.splice(index, 1);
            imageFiles.splice(index, 1);
            renderImages();
            
            if (images.length === 0) {
                analyzeButton.disabled = true;
                resetButton.classList.add('hidden');
            }
        }

        function renderImages() {
            imageGrid.innerHTML = '';
            
            images.forEach((image, index) => {
                const imageContainer = document.createElement('div');
                imageContainer.className = 'image-container';
                
                const img = document.createElement('img');
                img.className = 'image-preview';
                img.src = image;
                
                const removeBtn = document.createElement('button');
                removeBtn.className = 'remove-button';
                removeBtn.innerHTML = '<i class="material-icons">close</i>';
                removeBtn.addEventListener('click', () => removeImage(index));
                
                imageContainer.appendChild(img);
                imageContainer.appendChild(removeBtn);
                imageGrid.appendChild(imageContainer);
            });
            
            if (images.length < 3) {
                const addContainer = document.createElement('div');
                addContainer.className = 'image-container add-image';
                addContainer.id = 'add-image';
                addContainer.innerHTML = '<i class="material-icons">add_a_photo</i>';
                addContainer.addEventListener('click', () => fileInput.click());
                imageGrid.appendChild(addContainer);
            }
        }

        function showError(message) {
            errorContainer.innerHTML = `
                <div class="error-message">
                    <i class="material-icons" style="vertical-align: middle;">error</i>
                    ${message}
                </div>
            `;
            errorContainer.classList.remove('hidden');
            
            // Hide after 5 seconds
            setTimeout(() => {
                errorContainer.classList.add('hidden');
            }, 5000);
        }

        async function analyzeImages() {
            const apiKey = apiKeyInput.value.trim();
            if (!apiKey) {
                showError("Lütfen geçerli bir OpenAI API anahtarı girin");
                return;
            }

            if (images.length === 0 || isAnalyzing) return;
            
            isAnalyzing = true;
            buttonText.textContent = 'Analiz Ediliyor...';
            spinner.classList.remove('hidden');
            analyzeButton.disabled = true;
            analysisResults.innerHTML = '';
            resultsContainer.classList.remove('hidden');
            errorContainer.classList.add('hidden');
            
            try {
                for (let i = 0; i < images.length; i++) {
                    const imageFile = imageFiles[i];
                    const base64Image = await toBase64(imageFile);
                    
                    const analysis = await callChatGPTAPI(apiKey, base64Image);
                    
                    const analysisElement = document.createElement('div');
                    analysisElement.className = 'analysis-container';
                    analysisElement.innerHTML = `
                        <div class="analysis-title">Görsel ${i + 1} Analizi:</div>
                        <div class="analysis-text">${analysis}</div>
                    `;
                    
                    analysisResults.appendChild(analysisElement);
                    
                    // Small delay between images for better UX
                    if (i < images.length - 1) {
                        await new Promise(resolve => setTimeout(resolve, 1000));
                    }
                }
            } catch (error) {
                console.error('API Error:', error);
                showError(`
                    API isteği başarısız oldu. Lütfen:<br>
                    1. API anahtarınızı kontrol edin<br>
                    2. İnternet bağlantınızı kontrol edin<br>
                    3. Daha sonra tekrar deneyin<br>
                    <small>Hata detayı: ${error.message}</small>
                `);
            }
            
            isAnalyzing = false;
            buttonText.textContent = 'Dayıya Sor';
            spinner.classList.add('hidden');
            analyzeButton.disabled = false;
        }

        function toBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => {
                    const base64String = reader.result.split(',')[1];
                    resolve(base64String);
                };
                reader.onerror = error => reject(error);
            });
        }

        async function callChatGPTAPI(apiKey, base64Image) {
            const prompt = `
                Sen bir falcısın ve bu resme bakarak fal yorumluyorsun. 
                Resmi detaylıca inceleyip fal yorumu yapacaksın.
                Yorumunu Türkçe ve anlaşılır bir şekilde yap.
                Pozitif, gizemli ve fal bakıyormuş gibi bir üslup kullan.
                En az 3 cümlelik bir yorum yap.
                Direkt yoruma başla, başlık vs. koyma.
            `;

            const requestBody = {
                model: "gpt-4-vision-preview",
                messages: [
                    {
                        role: "user",
                        content: [
                            { type: "text", text: prompt },
                            {
                                type: "image_url",
                                image_url: {
                                    url: `data:image/jpeg;base64,${base64Image}`
                                }
                            }
                        ]
                    }
                ],
                max_tokens: 1000
            };

            const response = await fetch("https://api.openai.com/v1/chat/completions", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${apiKey}`
                },
                body: JSON.stringify(requestBody)
            });

            if (!response.ok) {
                const errorData = await response.json();
                console.error('API Error Details:', errorData);
                throw new Error(`API hatası: ${errorData.error?.message || 'Bilinmeyen hata'}`);
            }

            const data = await response.json();
            
            // Debug log
            console.log('API Response:', data);
            
            if (data.choices?.[0]?.message?.content) {
                return data.choices[0].message.content;
            } else {
                console.error('Unexpected API response:', data);
                throw new Error('API beklenmeyen bir yanıt döndürdü');
            }
        }

        function resetAll() {
            images.length = 0;
            imageFiles.length = 0;
            isAnalyzing = false;
            renderImages();
            
            analyzeButton.disabled = true;
            buttonText.textContent = 'Dayıya Sor';
            spinner.classList.add('hidden');
            resultsContainer.classList.add('hidden');
            resetButton.classList.add('hidden');
            errorContainer.classList.add('hidden');
        }
    </script>
</body>
</html>
